env:
  BUILD_TIMEOUT: 120
  TEST_TIMEOUT: 60
  TIMEOUT: 120
  VERBOSE: true

steps:

  - label: ":webhook: Trigger Travis CI Build"
    command: |
      TRAVIS_MESSAGE="$BUILDKITE_MESSAGE - $(echo $BUILDKITE_BUILD_URL | grep -oe 'buildkite.*')"
      BODY="$(jq -nc '{"request":{"branch":env.BUILDKITE_BRANCH,"message":env.TRAVIS_MESSAGE}}')"
      echo $BODY
      RESULT="$(curl -s -X POST -H "Content-Type: application/json" -H "Accept: application/json" -H "Travis-API-Version: 3" -H "Authorization: token $TRAVIS_API_KEY" -d "$BODY" https://api.travis-ci.org/repo/EOSIO%2feos/requests)"
      echo $RESULT
      echo "$RESULT" | jq 2>/dev/null || echo "$RESULT"
      if [[ "$(echo $RESULT | jq -r '.["@type"]')" != "pending" ]]; then
          echo '+++ :no_entry: ERROR: Failed to trigger Travis API!'
          exit 1
      fi
    agents:
      queue: "automation-basic-builder-fleet"

  - trigger: "eos-vm-base-images-beta"
    label: ":docker: Ensure base images exist"
    build:
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"

  - wait

  - label: ":ubuntu: [Ubuntu] 18.04 Build"
    agents:
      queue: "automation-eos-builder-fleet"
    plugins:
      - docker#v3.2.0:
          debug: $DEBUG
          image: "eosio/producer:eos-vm-ubuntu-18.04-8c69e80af565dc124d8218693ea7a548ca9dd359"
    timeout: $BUILD_TIMEOUT
    skip: $SKIP_UBUNTU_18